<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Grzybownik ‚Äî iOS Edition</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Grzybownik">
  <link rel="apple-touch-icon" href="icons/icon-180.png">
  <meta name="theme-color" content="#0b6b3a">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <style>
    :root{
      --bg:#f7f8f9;
      --card:#ffffffcc;
      --blur:20px;
      --border:#e6e8eb;
      --text:#0f172a;
      --muted:#6b7280;
      --accent:#0b6b3a;
      --accent-soft:#d6f3df;
      --shadow: 0 10px 30px rgba(11,107,58,0.12);
      --radius: 16px;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b1220;
        --card:#0f172acc;
        --border:#1f2937;
        --text:#e5e7eb;
        --muted:#94a3b8;
        --shadow: 0 10px 30px rgba(0,0,0,0.4);
      }
    }
    *{box-sizing:border-box}
    html, body { height: 100%; margin:0; font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--text); background:var(--bg); }
    #app { display: grid; grid-template-rows: 64px 1fr; height: 100%; }
    header {
      position: sticky; top:0; z-index: 1000;
      display:flex; align-items:center; gap:10px; padding:10px 14px;
      -webkit-backdrop-filter: blur(var(--blur)); backdrop-filter: blur(var(--blur));
      background: var(--card);
      border-bottom: 1px solid var(--border);
    }
    header h1 { font-size: 18px; margin:0; font-weight: 700; letter-spacing: .2px; }
    header .spacer { flex:1; }
    .btn {
      border:1px solid var(--border); background: #fff; color:#0b6b3a;
      padding:10px 14px; border-radius: 12px; cursor: pointer;
      transition: transform .05s ease, box-shadow .2s ease, background .2s ease;
      box-shadow: 0 2px 0 rgba(0,0,0,.04);
    }
    .btn:active{ transform: translateY(1px); }
    .btn-ghost{ background: transparent; color:var(--text); }
    .btn-accent{ background: var(--accent); color:#fff; border-color: transparent; }
    .chip { background:var(--accent-soft); color:var(--accent); padding:3px 10px; border-radius:999px; font-size:12px; }

    #content { display:grid; grid-template-columns: 1fr 380px; gap: 14px; padding:14px; }
    #mapWrap { position: relative; }
    #map { width: 100%; height: calc(100vh - 92px); border-radius: var(--radius); box-shadow: var(--shadow); }
    #mapToolbar {
      position:absolute; top:12px; right:12px; display:flex; gap:8px;
      background: var(--card); border:1px solid var(--border); border-radius: 12px; padding:6px;
      -webkit-backdrop-filter: blur(var(--blur)); backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
    }
    .toggle { display:flex; align-items:center; gap:8px; padding:6px 10px; border-radius:10px; cursor:pointer; border:1px solid var(--border); background: #fff; }
    .toggle input{ accent-color: var(--accent); }

    #side { height: calc(100vh - 92px); overflow:auto; padding:0; }
    .card {
      background: var(--card); border:1px solid var(--border); border-radius: var(--radius);
      box-shadow: var(--shadow); padding: 12px; margin-bottom: 12px;
    }
    .toolbar { display:flex; gap:8px; margin-bottom: 12px; }
    .input {
      border:1px solid var(--border); background: #fff; padding:10px 12px; border-radius: 12px; width:100%;
    }
    .field { display:flex; flex-direction:column; gap:6px; margin-bottom:10px; }
    .field label { font-size: 12px; color: var(--muted); }
    textarea { min-height: 80px; resize: vertical; }

    .spot { display:flex; flex-direction:column; gap:6px; }
    .spot h3 { margin:0; font-size:16px; }
    .spot small { color: var(--muted); }
    .row { display:flex; gap:8px; }
    .row > * { flex:1; }
    .tags { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
    .tag { background:var(--accent-soft); color:var(--accent); padding:3px 10px; border-radius:999px; font-size:12px; }
    .danger { color:#ef4444; }

    .hidden { display:none; }

    @media (max-width: 980px) {
      #content { grid-template-columns: 1fr; }
      #side {
        position: fixed; right: 12px; left: 12px; top: 92px; bottom: 12px;
        transform: translateY(110%); transition: transform .25s ease;
      }
      #side.open { transform: translateY(0); }
    }
  </style>
</head>
<body>
<div id="app">
  <header class="card" style="margin:0; border-radius:0;">
    <button id="toggleSide" class="btn btn-ghost">‚ò∞</button>
    <h1>Grzybownik</h1>
    <div class="spacer"></div>
    <button id="btnAdd" class="btn">‚ûï Dodaj</button>
    <button id="btnLocate" class="btn btn-accent">üìç Pozycja</button>
  </header>

  <div id="content">
    <div id="mapWrap">
      <div id="map"></div>
      <div id="mapToolbar">
        <label class="toggle">
          <input id="satToggle" type="checkbox" />
          <span>Mapa satelitarna</span>
        </label>
      </div>
    </div>

    <aside id="side">
      <div class="card">
        <div class="toolbar">
          <input type="text" id="search" class="input" placeholder="Szukaj po nazwie, gatunku..." />
          <button id="btnExport" class="btn">‚¨áÔ∏è Eksport</button>
          <label for="importFile" class="btn">‚¨ÜÔ∏è Import</label>
          <input class="hidden" type="file" id="importFile" accept="application/json,.geojson" />
        </div>
        <form id="form" class="hidden">
          <div class="field"><label>Nazwa miejsc√≥wki</label><input id="name" class="input" type="text" placeholder='np. "Sosnowy skraj pod SmerdynƒÖ"' /></div>
          <div class="row">
            <div class="field"><label>Szeroko≈õƒá</label><input id="lat" class="input" type="text" readonly /></div>
            <div class="field"><label>D≈Çugo≈õƒá</label><input id="lng" class="input" type="text" readonly /></div>
          </div>
          <div class="field"><label>Gatunki (tagi, wpisz i Enter)</label>
            <input id="speciesInput" class="input" type="text" placeholder="np. borowik, podgrzybek, kurka" />
            <div id="speciesTags" class="tags"></div>
          </div>
          <div class="field"><label>Notatki</label><textarea id="notes" class="input" placeholder="gleba piaszczysta, ≈õwierk, najwiƒôcej po deszczu..."></textarea></div>
          <div class="row">
            <div class="field"><label>Ocena obfito≈õci</label>
              <select id="rating" class="input">
                <option value="1">1 ‚Äî s≈Çabo</option>
                <option value="2">2</option>
                <option value="3" selected>3 ‚Äî ≈õrednio</option>
                <option value="4">4</option>
                <option value="5">5 ‚Äî z≈Çote miejsce</option>
              </select>
            </div>
            <div class="field"><label>Sezon</label>
              <select id="season" class="input">
                <option value="wiosna">Wiosna</option>
                <option value="lato">Lato</option>
                <option value="jesie≈Ñ" selected>Jesie≈Ñ</option>
                <option value="zima">Zima</option>
              </select>
            </div>
          </div>
          <div class="field"><label>Zdjƒôcie (opcjonalnie)</label>
            <input id="photo" class="input" type="file" accept="image/*" />
          </div>
          <div class="row">
            <button type="button" id="save" class="btn btn-accent">üíæ Zapisz</button>
            <button type="button" id="cancel" class="btn">Anuluj</button>
          </div>
          <p class="muted" style="color:var(--muted); font-size:12px; margin:8px 0 0;">Dane trzymane lokalnie (localStorage). Eksport do GeoJSON dostƒôpny z poziomu aplikacji.</p>
        </form>
      </div>

      <div id="list"></div>
    </aside>
  </div>
</div>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
(function(){
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => navigator.serviceWorker.register('sw.js').catch(()=>{}));
  }

  const $ = s => document.querySelector(s);
  const map = L.map('map', { zoomControl: true });
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap'
  });
  const esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles &copy; Esri &mdash; Source: Esri, Maxar, Earthstar Geographics, and the GIS User Community'
  });

  // Restore base layer preference
  const basePref = localStorage.getItem('grzybownik_base') || 'osm';
  if (basePref === 'sat') { esri.addTo(map); } else { osm.addTo(map); }

  const clusters = L.markerClusterGroup();
  clusters.addTo(map);

  const state = { spots: loadSpots(), editId: null, filter: '' };

  // Start view Poland
  map.setView([52.0, 19.0], 6);

  // UI refs
  const side = $('#side');
  const form = $('#form');
  const list = $('#list');
  const nameEl = $('#name');
  const latEl = $('#lat');
  const lngEl = $('#lng');
  const notesEl = $('#notes');
  const ratingEl = $('#rating');
  const seasonEl = $('#season');
  const photoEl = $('#photo');
  const speciesInput = $('#speciesInput');
  const speciesTags = $('#speciesTags');
  const satToggle = $('#satToggle');

  // Init toggle state
  satToggle.checked = (basePref === 'sat');
  satToggle.addEventListener('change', ()=>{
    if (satToggle.checked) { map.removeLayer(osm); esri.addTo(map); localStorage.setItem('grzybownik_base','sat'); }
    else { map.removeLayer(esri); osm.addTo(map); localStorage.setItem('grzybownik_base','osm'); }
  });

  $('#toggleSide').addEventListener('click', ()=> side.classList.toggle('open'));

  $('#btnLocate').addEventListener('click', ()=>{
    if (!navigator.geolocation) return alert('Geolokalizacja niedostƒôpna.');
    navigator.geolocation.getCurrentPosition(pos => {
      const {latitude, longitude} = pos.coords;
      map.setView([latitude, longitude], 15);
      L.circle([latitude, longitude], {radius: 10}).addTo(map);
    }, () => alert('Brak zgody na lokalizacjƒô lub b≈ÇƒÖd.'));
  });

  $('#btnAdd').addEventListener('click', ()=>{
    const center = map.getCenter();
    openForm({ lat: center.lat, lng: center.lng });
  });

  $('#search').addEventListener('input', (e)=>{
    state.filter = e.target.value.toLowerCase();
    render();
  });

  $('#importFile').addEventListener('change', async (e)=>{
    const file = e.target.files[0];
    if (!file) return;
    const text = await file.text();
    try {
      const geo = JSON.parse(text);
      if (geo.type === 'FeatureCollection') {
        const added = geo.features.map(f => featureToSpot(f)).filter(Boolean);
        state.spots.push(...added);
        saveSpots(state.spots);
        render();
        alert('Zaimportowano ' + added.length + ' miejsc√≥wek.');
      } else { alert('To nie jest poprawny GeoJSON FeatureCollection.'); }
    } catch (err) { alert('B≈ÇƒÖd importu: ' + err.message); }
  });

  $('#btnExport').addEventListener('click', ()=>{
    const geo = spotsToGeoJSON(state.spots);
    const blob = new Blob([JSON.stringify(geo, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'grzybownik.geojson'; a.click();
    URL.revokeObjectURL(url);
  });

  $('#save').addEventListener('click', async ()=>{
    const file = photoEl.files[0];
    let photoData = null;
    if (file) photoData = await fileToDataURL(file);
    const species = tagValues();
    const data = {
      id: state.editId || uid(),
      name: nameEl.value.trim() || 'Bez nazwy',
      lat: parseFloat(latEl.value),
      lng: parseFloat(lngEl.value),
      species,
      notes: notesEl.value.trim(),
      rating: parseInt(ratingEl.value, 10) || 3,
      season: seasonEl.value,
      photo: photoData,
      createdAt: state.editId ? (findSpot(state.editId)?.createdAt || Date.now()) : Date.now()
    };
    if (state.editId) {
      const i = state.spots.findIndex(s => s.id === state.editId);
      state.spots[i] = data;
    } else { state.spots.push(data); }
    saveSpots(state.spots);
    closeForm();
    render();
  });
  $('#cancel').addEventListener('click', closeForm);

  speciesInput.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter') {
      e.preventDefault();
      const v = speciesInput.value.trim();
      if (v) addTag(v);
      speciesInput.value='';
    }
  });

  function addTag(text){
    const chip = document.createElement('span');
    chip.className = 'tag'; chip.textContent = text;
    chip.title = 'Usu≈Ñ'; chip.style.cursor='pointer';
    chip.addEventListener('click', ()=> chip.remove());
    speciesTags.appendChild(chip);
  }
  function tagValues(){ return Array.from(speciesTags.querySelectorAll('.tag')).map(el=>el.textContent); }
  function clearTags(){ speciesTags.innerHTML=''; }

  function openForm({lat, lng, spot}){
    form.classList.remove('hidden');
    nameEl.value = spot?.name || '';
    latEl.value = (spot?.lat ?? lat).toFixed(6);
    lngEl.value = (spot?.lng ?? lng).toFixed(6);
    notesEl.value = spot?.notes || '';
    ratingEl.value = spot?.rating || 3;
    seasonEl.value = spot?.season || 'jesie≈Ñ';
    photoEl.value = '';
    clearTags();
    (spot?.species || []).forEach(addTag);
    state.editId = spot?.id || null;
    side.classList.add('open');
    nameEl.focus();
  }
  function closeForm(){ form.classList.add('hidden'); state.editId = null; }

  function render(){
    clusters.clearLayers();
    const items = filteredSpots();
    items.forEach(s => {
      const m = L.marker([s.lat, s.lng]);
      m.bindPopup(popupHTML(s));
      clusters.addLayer(m);
    });
    list.innerHTML = '';
    items.sort((a,b)=>b.createdAt - a.createdAt).forEach(s => list.appendChild(spotCard(s)));
  }

  function popupHTML(s){
    const tags = s.species?.length ? s.species.map(t=>`<span class="chip">${escapeHtml(t)}</span>`).join(' ') : '<em>brak gatunk√≥w</em>';
    const img = s.photo ? `<img style="width:100%;border-radius:12px;border:1px solid var(--border);margin-top:6px" src="${s.photo}" alt="${escapeHtml(s.name)}"/>` : '';
    return `<div style="min-width:240px">
      <strong>${escapeHtml(s.name)}</strong><br/>
      <small style="color:var(--muted)">${s.lat.toFixed(5)}, ${s.lng.toFixed(5)} ‚Ä¢ ocena ${s.rating}/5 ‚Ä¢ ${s.season}</small>
      <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:6px">${tags}</div>
      ${s.notes ? `<p style="margin:6px 0 0">${escapeHtml(s.notes)}</p>` : ''}
      ${img}
      <div style="margin-top:8px; display:flex; gap:6px">
        <button class="btn" onclick="window._edit('${s.id}')">‚úèÔ∏è Edytuj</button>
        <button class="btn danger" onclick="window._remove('${s.id}')">üóë Usu≈Ñ</button>
      </div>
    </div>`;
  }

  window._edit = (id)=>{
    const s = findSpot(id); if (!s) return;
    openForm({ lat: s.lat, lng: s.lng, spot: s });
  };
  window._remove = (id)=>{
    if (!confirm('UsunƒÖƒá miejsc√≥wkƒô?')) return;
    state.spots = state.spots.filter(s => s.id !== id);
    saveSpots(state.spots);
    render();
  };
  window._zoom = (id)=>{
    const s = findSpot(id); if (!s) return;
    side.classList.remove('open');
    map.setView([s.lat, s.lng], 16);
  };

  function spotCard(s){
    const el = document.createElement('div');
    el.className = 'card spot';
    el.innerHTML = `
      <h3>${escapeHtml(s.name)}</h3>
      <small>${new Date(s.createdAt).toLocaleDateString()} ‚Ä¢ ${s.lat.toFixed(5)}, ${s.lng.toFixed(5)} ‚Ä¢ ocena ${s.rating}/5 ‚Ä¢ ${s.season}</small>
      <div class="tags">${(s.species||[]).map(t=>`<span class='tag'>${escapeHtml(t)}</span>`).join(' ')}</div>
      ${s.notes ? `<p>${escapeHtml(s.notes)}</p>` : ''}
      ${s.photo ? `<img style="width:100%;border-radius:12px;border:1px solid var(--border)" src="${s.photo}" alt="${escapeHtml(s.name)}"/>` : ''}
      <div class="row" style="margin-top:6px">
        <button class="btn" onclick="window._zoom('${s.id}')">üó∫ Poka≈º</button>
        <button class="btn" onclick="window._edit('${s.id}')">‚úèÔ∏è Edytuj</button>
        <button class="btn danger" onclick="window._remove('${s.id}')">üóë Usu≈Ñ</button>
      </div>
    `;
    return el;
  }

  function filteredSpots(){
    const q = state.filter;
    if (!q) return [...state.spots];
    return state.spots.filter(s => (
      (s.name||'').toLowerCase().includes(q) ||
      (s.notes||'').toLowerCase().includes(q) ||
      (s.species||[]).some(t => (t||'').toLowerCase().includes(q))
    ));
  }
  function findSpot(id){ return state.spots.find(s => s.id === id); }
  function loadSpots(){ try { return JSON.parse(localStorage.getItem('grzybownik_spots')||'[]'); } catch(e){ return []; } }
  function saveSpots(arr){ localStorage.setItem('grzybownik_spots', JSON.stringify(arr)); }
  function spotsToGeoJSON(spots){
    return { type:'FeatureCollection', features: spots.map(s => ({
      type:'Feature',
      properties: { id:s.id, name:s.name, species:s.species, notes:s.notes, rating:s.rating, season:s.season, createdAt:s.createdAt, photo:s.photo },
      geometry: { type:'Point', coordinates:[s.lng, s.lat] }
    }))};
  }
  function featureToSpot(f){
    try {
      const [lng, lat] = f.geometry.coordinates;
      const p = f.properties||{};
      return { id: p.id || uid(), name: p.name||'Bez nazwy', lat, lng, species: p.species||[], notes: p.notes||'', rating: p.rating||3, season: p.season||'jesie≈Ñ', photo: p.photo||null, createdAt: p.createdAt || Date.now() };
    } catch(e){ return null; }
  }
  function fileToDataURL(file){
    return new Promise((resolve, reject)=>{
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }
  function uid(){ return 's_' + Math.random().toString(36).slice(2,10); }
  function escapeHtml(str){ return String(str).replace(/[&<>\"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s])); }

  render();
})();
</script>
</body>
</html>
